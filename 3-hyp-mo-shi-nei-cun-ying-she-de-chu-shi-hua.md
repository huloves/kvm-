# 3 hyp模式内存映射的初始化

> 内核版本：linux-5.9
>
> 架构：arm64

本文作如下**约束**：未开启vhe。

本文作如下**规定**：在EL1运行linux宿主机时为host模式，在EL1运行客户机时为guest模式，在EL2运行时为hyp模式。

### 3.1 hyp模式内存映射

通过前文描述可知，在kvm的场景下，有部分代码是需要在EL2异常级别运行。arm64架构中每个异常级别有自己的运行环境，即每个异常级别有自己的系统寄存器控制当前的运行环境。在运行环境中，对内存的设置至关重要，例如当前异常级别是否开启虚拟内存。

这里涉及arm64架构的规范，对初始化相关的内容作简要说明。EL1异常级别和EL2异常级别有各自的系统控制寄存器，即`SCTLR_EL1`和`SCTLR_EL2`，这两个寄存器的第0位是否开启MMU。未开启MMU则访存以物理内存直接寻址，开启后访存则需要经过MMU转换。EL1的设置本文不进行讲解，着重讲解EL2的设置，当EL2开启MMU后，转换所需要的转换表存储在`TTBR0_EL2`寄存器中。

> 这里注意区分后文会提到的控制阶段二地址转换的`VTCR_EL2`寄存器，以及阶段二地址转换所需的`VTTBR_EL2`寄存器。

